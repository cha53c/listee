<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><%= title %></title>
    <style>
        div.list-item {
            display: inline-block;
        }
    </style>
</head>
<body>
<h1><%= heading %></h1>
<label>list name</label>
<input id="listname" type="text" placeholder="list name">
<button type="button" id="submit" value="Add Item">Create list</button>
<br>
<h2>List Items</h2>
<div id="list-items"></div>
<%- include('list/addItem', { classStr: ''}) %>
<br>
<%- include('list/listFunctions'); %>
<script>
    <!--    TODO move JS to a separate file -->
    let itemNum = 0;
    const namesString = "<%= listnames %>";
    let x = namesString.split(',');

    document.getElementById('add').onclick = function addItem() {
        let item = document.getElementById('item-input').value;
        if (item === '') {
            console.log('item is empty');
            return;
        }
        console.log('adding an item');
        console.log(item);
        let key = '' + itemNum++;
        appendListItem(item, key);
        document.getElementById('item-input').value = ''; // reset input text
        setAddItemfocus();
    }

    function appendListItem(item, id) {
        let rowDiv = document.createElement('DIV')
        rowDiv.setAttribute('class', 'list-row');
        let itemDiv = document.createElement('DIV');
        itemDiv.setAttribute('id', id);
        itemDiv.setAttribute('class', 'list-item');
        let textNode = document.createTextNode(item)
        itemDiv.appendChild(textNode);
        document.getElementById('list-items').appendChild(rowDiv);
        rowDiv.appendChild(itemDiv)
        appendRemoveButton(rowDiv, itemDiv.id);
    }

    function appendRemoveButton(parent, itemId) {
        let button = document.createElement('BUTTON');
        button.setAttribute('class', 'remove-btn');
        button.setAttribute('data-itemId', itemId);
        let textNode = document.createTextNode('remove')
        button.appendChild(textNode);
        parent.appendChild(button);
        button.addEventListener('click', function (event) {
            console.log('you clicked remove');
            console.log(event);
            let itemId = event.target.getAttribute('data-itemId');
            removeItem(itemId);
        });
    }

    //remove from Map and DOM
    function removeItem(itemId) {
        let element = document.getElementById(itemId);
        removeListRow(element);
    }

    const xhr = new XMLHttpRequest();
    xhr.onload = function () {
        window.location = this.responseURL;
    };

    document.getElementById('submit').onclick = function submitList() {
        let listname = document.getElementById('listname').value;
        if (listname === '') {
            console.log('list name is empty');
            alert('add a list name to create your list');
            return;
        }

        // TODO don't create if list name already exists
        console.log('listnames ' + x);
        console.log('listnames number ' + x.length);
        if (x.length > 0) {
            console.log('there are list names');
            if (x.includes(listname)) {
                alert('you already have a list with the same name, choose another name');
                return;
            }
        }

        let items = [];
        // TODO can you dry this up using closures?
        let elements = document.getElementsByClassName('list-item');
        console.log(elements);
        for (const el of elements) {
            console.log(el.innerText);
            items.push(el.innerText);
        }
        if (items.size == 0) {
            alert('your list is empty add some items');
            return;
        }
        // console.log(Array.from(items.values()));
        console.log(items);
        let list = {
            listname: listname,
            // items: Array.from(items.values())
            items: items
        }


        xhr.open("POST", '/lists/<%= userId %>/create/', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(list));
    }

    window.onload = function () {
        setAddItemfocus();
        const item = document.getElementById("item-input");
        const listname = document.getElementById('listname');
        const removeBtns = document.getElementsByClassName('remove-btn');

        // Execute a function when the user releases a key on the keyboard
        item.addEventListener("keyup", function (event) {
            // Number 13 is the "Enter" key on the keyboard
            if (event.keyCode === 13) {
                // Cancel the default action, if needed
                event.preventDefault();
                // Trigger the button element with a click
                console.log('you hit enter');
                document.getElementById('add').click();
            }
        });
        listname.addEventListener("keyup", function (event) {
            // Number 13 is the "Enter" key on the keyboard
            if (event.keyCode === 13) {
                // Cancel the default action, if needed
                event.preventDefault();
                // Trigger the button element with a click
                console.log('you hit enter');
                document.getElementById('submit').click();
            }
        })
    };

    function setAddItemfocus() {
        document.getElementById("item-input").focus();
    }

</script>
</body>
</html>